<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Admin Interface</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #444;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        .post-list {
            border-right: 1px solid #eee;
            padding-right: 20px;
        }
        .post-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .post-item:hover {
            background-color: #f9f9f9;
        }
        .post-item.active {
            background-color: #e0f7ff;
            border-color: #56c0e0;
        }
        .post-editor {
            padding: 0 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
        }
        textarea {
            min-height: 200px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        .checkbox-group input {
            margin-right: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #0b7dda;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #d32f2f;
        }
        .button-group {
            margin-top: 20px;
        }
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .tag {
            background-color: #e1e1e1;
            padding: 5px 10px;
            border-radius: 15px;
            display: flex;
            align-items: center;
        }
        .tag button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0 5px;
            margin: 0 0 0 5px;
        }
        #add-tag-form {
            display: flex;
            margin-top: 10px;
        }
        #add-tag-form input {
            flex-grow: 1;
            margin-right: 10px;
        }
        #add-tag-form button {
            padding: 8px 15px;
        }
        .response-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        #loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Blog Admin Interface</h1>
    <div class="container">
        <div class="post-list">
            <h2>Posts</h2>
            <button id="new-post-btn" class="secondary">New Post</button>
            <div id="post-items">
                <!-- Post items will be added here -->
                <div class="post-item">Loading posts...</div>
            </div>
        </div>

        <div class="post-editor">
            <h2 id="editor-title">Create New Post</h2>
            <form id="post-form">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" required>
                </div>

                <div class="form-group">
                    <label for="slug">Slug</label>
                    <input type="text" id="slug" name="slug" required>
                </div>

                <div class="form-group">
                    <label for="date">Date (YYYY-MM-DD)</label>
                    <input type="text" id="date" name="date" required>
                </div>

                <div class="form-group">
                    <label for="author">Author</label>
                    <input type="text" id="author" name="author" required>
                </div>

                <div class="form-group">
                    <label for="excerpt">Excerpt</label>
                    <textarea id="excerpt" name="excerpt" required></textarea>
                </div>

                <div class="form-group">
                    <label for="content">Content (Markdown)</label>
                    <textarea id="content" name="content" required></textarea>
                </div>

                <div class="form-group">
                    <label for="image">Image URL (optional)</label>
                    <input type="text" id="image" name="image">
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="published" name="published">
                    <label for="published">Published</label>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="featured" name="featured">
                    <label for="featured">Featured</label>
                </div>

                <div class="form-group">
                    <label>Tags</label>
                    <div class="tag-container" id="tags-container">
                        <!-- Tags will be added here -->
                    </div>
                    <div id="add-tag-form">
                        <input type="text" id="new-tag" placeholder="Add new tag">
                        <button type="button" id="add-tag-btn">Add Tag</button>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" id="save-btn">Save Post</button>
                    <button type="button" id="delete-btn" class="danger">Delete Post</button>
                    <button type="button" id="cancel-btn" class="secondary">Cancel</button>
                </div>
            </form>

            <div id="loading">Loading...</div>

            <div class="response-container">
                <h3>API Response</h3>
                <pre id="response-data"></pre>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const postItemsEl = document.getElementById('post-items');
        const postFormEl = document.getElementById('post-form');
        const editorTitleEl = document.getElementById('editor-title');
        const titleEl = document.getElementById('title');
        const slugEl = document.getElementById('slug');
        const dateEl = document.getElementById('date');
        const authorEl = document.getElementById('author');
        const excerptEl = document.getElementById('excerpt');
        const contentEl = document.getElementById('content');
        const imageEl = document.getElementById('image');
        const publishedEl = document.getElementById('published');
        const featuredEl = document.getElementById('featured');
        const tagsContainerEl = document.getElementById('tags-container');
        const newTagEl = document.getElementById('new-tag');
        const addTagBtnEl = document.getElementById('add-tag-btn');
        const saveBtnEl = document.getElementById('save-btn');
        const deleteBtnEl = document.getElementById('delete-btn');
        const cancelBtnEl = document.getElementById('cancel-btn');
        const newPostBtnEl = document.getElementById('new-post-btn');
        const responseDataEl = document.getElementById('response-data');
        const loadingEl = document.getElementById('loading');

        // State
        let posts = [];
        let currentPost = null;
        let currentTags = [];

        // API base URL
        const API_BASE_URL = '/api/blog';

        // Initialize
        initApp();

        // Event listeners
        titleEl.addEventListener('blur', generateSlug);
        addTagBtnEl.addEventListener('click', addTag);
        postFormEl.addEventListener('submit', savePost);
        deleteBtnEl.addEventListener('click', deletePost);
        cancelBtnEl.addEventListener('click', resetForm);
        newPostBtnEl.addEventListener('click', createNewPost);

        // Initialize the application
        async function initApp() {
            try {
                await fetchPosts();
                resetForm();
                setCurrentDate();
            } catch (error) {
                console.error('Error initializing app:', error);
                showResponse({ error: 'Failed to initialize application' });
            }
        }

        // Set current date
        function setCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateEl.value = `${year}-${month}-${day}`;
        }

        // Fetch all posts
        async function fetchPosts() {
            showLoading(true);
            try {
                const response = await fetch(API_BASE_URL);
                const data = await response.json();
                posts = data;
                renderPosts();
                showResponse(data);
            } catch (error) {
                console.error('Error fetching posts:', error);
                showResponse({ error: 'Failed to fetch posts' });
            } finally {
                showLoading(false);
            }
        }

        // Render posts in the sidebar
        function renderPosts() {
            postItemsEl.innerHTML = '';

            if (posts.length === 0) {
                postItemsEl.innerHTML = '<div class="post-item">No posts found</div>';
                return;
            }

            posts.forEach(post => {
                const postEl = document.createElement('div');
                postEl.className = 'post-item';
                postEl.innerHTML = `
                    <h3>${post.title}</h3>
                    <p>${post.date} • ${post.published ? 'Published' : 'Draft'}</p>
                `;
                postEl.addEventListener('click', () => selectPost(post));
                postItemsEl.appendChild(postEl);
            });
        }

        // Select a post to edit
        function selectPost(post) {
            currentPost = post;
            editorTitleEl.textContent = 'Edit Post';

            // Fill form fields
            titleEl.value = post.title || '';
            slugEl.value = post.slug || '';
            dateEl.value = post.date || '';
            authorEl.value = post.author || '';
            excerptEl.value = post.excerpt || '';
            contentEl.value = post.content || '';
            imageEl.value = post.image || '';
            publishedEl.checked = post.published || false;
            featuredEl.checked = post.featured || false;

            // Set tags
            currentTags = [...post.tags];
            renderTags();

            // Update active post in sidebar
            document.querySelectorAll('.post-item').forEach(el => {
                el.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Show response
            showResponse(post);
        }

        // Create a new post
        function createNewPost() {
            currentPost = null;
            editorTitleEl.textContent = 'Create New Post';

            // Clear form fields
            postFormEl.reset();
            setCurrentDate();
            currentTags = [];
            renderTags();

            // Remove active class from sidebar
            document.querySelectorAll('.post-item').forEach(el => {
                el.classList.remove('active');
            });

            // Show empty response
            showResponse({ message: 'Creating a new post' });
        }

        // Generate slug from title
        function generateSlug() {
            if (titleEl.value && !slugEl.value) {
                const slug = titleEl.value
                    .toLowerCase()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/\s+/g, '-');
                slugEl.value = slug;
            }
        }

        // Add a tag to the current post
        function addTag() {
            const tagName = newTagEl.value.trim();
            if (!tagName) return;

            const slug = tagName
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-');

            const newTag = {
                id: null,
                name: tagName,
                slug: slug
            };

            currentTags.push(newTag);
            newTagEl.value = '';
            renderTags();
        }

        // Remove a tag from the current post
        function removeTag(index) {
            currentTags.splice(index, 1);
            renderTags();
        }

        // Render tags in the tag container
        function renderTags() {
            tagsContainerEl.innerHTML = '';

            currentTags.forEach((tag, index) => {
                const tagEl = document.createElement('div');
                tagEl.className = 'tag';
                tagEl.innerHTML = `
                    <span>${tag.name}</span>
                    <button type="button" class="remove-tag">&times;</button>
                `;
                tagEl.querySelector('.remove-tag').addEventListener('click', () => removeTag(index));
                tagsContainerEl.appendChild(tagEl);
            });
        }

        // Save a post (create or update)
        async function savePost(event) {
            event.preventDefault();
            showLoading(true);

            const postData = {
                title: titleEl.value,
                slug: slugEl.value,
                date: dateEl.value,
                author: authorEl.value,
                excerpt: excerptEl.value,
                content: contentEl.value,
                image: imageEl.value || null,
                published: publishedEl.checked,
                featured: featuredEl.checked,
                tags: currentTags,
                metadata: {}
            };

            // If editing, include the ID
            if (currentPost && currentPost.id) {
                postData.id = currentPost.id;
            }

            try {
                let response;

                if (currentPost && currentPost.id) {
                    // Update existing post
                    response = await fetch(`${API_BASE_URL}/${postData.slug}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(postData)
                    });
                } else {
                    // Create new post
                    response = await fetch(API_BASE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(postData)
                    });
                }

                if (!response.ok) {
                    throw new Error(`API responded with status ${response.status}`);
                }

                const data = await response.json();
                showResponse(data);

                // Refresh posts list
                await fetchPosts();

                // Select the new/updated post
                const updatedPost = posts.find(p => p.id === data.id);
                if (updatedPost) {
                    selectPost(updatedPost);
                }

            } catch (error) {
                console.error('Error saving post:', error);
                showResponse({ error: 'Failed to save post: ' + error.message });
            } finally {
                showLoading(false);
            }
        }

        // Delete a post
        async function deletePost() {
            if (!currentPost || !currentPost.id) {
                showResponse({ error: 'No post selected for deletion' });
                return;
            }

            if (!confirm(`Are you sure you want to delete "${currentPost.title}"?`)) {
                return;
            }

            showLoading(true);

            try {
                const response = await fetch(`${API_BASE_URL}/${currentPost.slug}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`API responded with status ${response.status}`);
                }

                showResponse({ message: 'Post deleted successfully' });

                // Refresh posts list and reset form
                await fetchPosts();
                resetForm();

            } catch (error) {
                console.error('Error deleting post:', error);
                showResponse({ error: 'Failed to delete post: ' + error.message });
            } finally {
                showLoading(false);
            }
        }

        // Reset the form
        function resetForm() {
            currentPost = null;
            editorTitleEl.textContent = 'Create New Post';
            postFormEl.reset();
            setCurrentDate();
            currentTags = [];
            renderTags();

            // Remove active class from sidebar
            document.querySelectorAll('.post-item').forEach(el => {
                el.classList.remove('active');
            });
        }

        // Show API response data
        function showResponse(data) {
            responseDataEl.textContent = JSON.stringify(data, null, 2);
        }

        // Show/hide loading indicator
        function showLoading(show) {
            loadingEl.style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
